<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <title>Entrance Counter</title>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    .gauge-chart {
      display: inline-block;
      width: 400px;
    }
  </style>
</head>

<body>
  <script>
    var socket = null;
    google.charts.load('current', { 'packages': ['gauge'] });
    let usersOnlineChart = null;
    let doorOneChart = null;
    let doorTwoChart = null;


    google.charts.setOnLoadCallback(function () {
      $(function () {
        socket = io();
        usersOnlineChart = new google.visualization.Gauge(document.getElementById("usersOnlineChart"));
        doorOneChart = new google.visualization.Gauge(document.getElementById("doorOneChart"));
        doorTwoChart = new google.visualization.Gauge(document.getElementById("doorTwoChart"));
        noiseChart = new google.visualization.Gauge(document.getElementById("noiseChart"));

        socket.on('onlineUserCount', function (msg) {
          $('#onlineCounter').html(msg);
          let chartData = [["Label", "Value"], ["Users Online", msg]];
          drawGaugeChart("usersOnlineChart", chartData);
        });

        socket.on('doorOne', function (msg) {
          $('#doorOne').html(msg);
          let chartData = [["Label", "Value"], ["Door one", msg]];
          drawGaugeChart("doorOneChart", chartData);
        });

        socket.on('doorTwo', function (msg) {
          $('#doorTwo').html(msg);
          let chartData = [["Label", "Value"], ["Door two", msg]];
          drawGaugeChart("doorTwoChart", chartData);
        });

        socket.on("noiseData", function (msg) {
          let chartData = [["Label", "Value"], ["Noise in dB", msg]];
          drawGaugeChart("noiseChart", chartData);
        })
      });
    });

    google.charts.load('current', { 'packages': ['corechart'] });
    google.charts.setOnLoadCallback(function () {
      $(function () {
        var dustChart = new google.visualization.LineChart(document.getElementById('dustinessOfTheAirChart'));
        var dustData = new google.visualization.DataTable();

        var options = {
          width: 900,
          height: 500,
          pointSize: 7,
          animation: {
            startup: true,
            duration: 1000,
            easing: 'in'
          }
        };

        dustData.addColumn("timeofday", "Hour");
        dustData.addColumn("number", "Dust Particles");

        $.get("/getAllDustParticles")
          .fail(() => alert("Could not load data from the server"))
          .always((d) => {
            dustData.addRows(d);
            dustChart.draw(dustData, options);
          });

        socket.on("onDustParticlesSensor", function (airDustinessAndtimeData) {
          dustData.addRow(airDustinessAndtimeData);
          dustChart.draw(dustData, options);
        });

        socket.on("onDustParticlesDataUpdated", function (airDustinessAndtimeData) {
          dustData.removeRows(0, dustData.getNumberOfRows());
          dustData.addRows(airDustinessAndtimeData);
          dustChart.draw(dustData, options);
        });


      })
    })

    function drawGaugeChart(chartName, chartData) {
      var value = chartData[1][1];
      var min = Math.floor(value / 10) * 10;
      var max = min + 10;
      var greenFrom = min;
      var greenTo = greenFrom + 3;
      var yellowFrom = max - 4;
      var yellowTo = yellowFrom + 2;
      var redFrom = max - 2;
      var redTo = max;
      var data = google.visualization.arrayToDataTable(chartData);

      var options = {
        width: 1000, height: 400,
        redFrom: redFrom, redTo: redTo,
        yellowFrom: yellowFrom, yellowTo: yellowTo,
        greenFrom: greenFrom, greenTo: greenTo,
        minorTicks: 5,
        min: min,
        max: max,
        animation: {
          easing: "out"
        }
      };

      switch (chartName) {
        case "usersOnlineChart":
          usersOnlineChart.draw(data, options);
          break;
        case "doorOneChart":
          doorOneChart.draw(data, options);
          break;
        case "doorTwoChart":
          doorTwoChart.draw(data, options);
          break;
        case "noiseChart":
          noiseChart.draw(data, options);
          break;
      }
    }
  </script>

  <div id="dustinessOfTheAirChart"></div>
  <h1>Online Users</h1>
  <h1 id="onlineCounter">0</h1>
  <h1>Door One</h1>
  <h1 id="doorOne">0</h1>
  <h1>Door Two</h1>
  <h1 id="doorTwo">0</h1>
  <div id="usersOnlineChart" class="gauge-chart"></div>
  <div id="doorOneChart" class="gauge-chart"></div>
  <div id="doorTwoChart" class="gauge-chart"></div>
  <div id="noiseChart" class="gauge-chart"></div>
</body>

</html>